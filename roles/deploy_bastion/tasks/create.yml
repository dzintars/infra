---

# Download Fedora ISO
# Copy kickstart file to accessible local_action

- name: copy kickstart file
  template:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    owner: qemu
    group: qemu
    mode: '0644'
  loop:
    - {src: 'kickstart.cfg.j2', dest: '/var/lib/libvirt/kickstart.cfg'}

# - name: create the qemu disk images
#   action: qemu-img dest=/home/dzintars/kvm/pools/bastion/bastion.ocp.example.com.qcow2 size=10 format="qcow2" options="preallocation=metadata"
#   with_items: disks
#   # delegate_to: localhost


# TODO: Change hardcoded home directory
- name: Create VMs
  command: >
    virt-install \
      --connect qemu:///system \
      --name bastion.ocp.example.com \
      --description 'DHCP, DNS, HAProxy, TFTP, Matchbox' \
      --vcpus 1 \
      --memory 2048 \
      --location /home/dzintars/kvm/iso/Fedora-Server-dvd-x86_64-30-1.2.iso \
      --disk path=/home/dzintars/kvm/pools/bastion/bastion.ocp.example.com.qcow2,size=10,cache=writeback,format=qcow2,io=threads,bus=virtio  \
      --hvm \
      --accelerate \
      --os-type linux \
      --os-variant Fedora30 \
      --network bridge=virbr0,model=virtio \
      --nographics \
      --memballoon virtio \
      --initrd-inject /var/lib/libvirt/kickstart.cfg \
      -x "ks=file:/kickstart.cfg" \
      -x 'console=ttyS0,115200 headless noshell nofirewire' \
      --debug

#       --noautoconsole \
# --console pty,target_type=serial \
# -x 'console=ttyS0,115200n8 serial' \
# Delete kickstart file